<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9ff, #e8f2ff);
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #e8f2ff, #f8f9ff);
        }

        .file-upload.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tool-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .tool-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .heatmap {
            display: grid;
            gap: 2px;
            margin: 20px 0;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .correlation-matrix {
            overflow-x: auto;
            margin: 20px 0;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .correlation-table th, .correlation-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .conversion-funnel {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .funnel-step {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px;
            min-width: 120px;
        }

        .funnel-arrow {
            font-size: 2rem;
            color: #667eea;
            margin: 0 10px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #667eea;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Advanced Data Analysis Dashboard</h1>
            <p>Upload CSV data for instant insights, visualizations, and statistical analysis</p>
        </div>

        <div class="upload-section">
            <div class="file-upload" id="fileUpload">
                <input type="file" id="csvFile" accept=".csv" multiple style="display: none;">
                <div id="uploadText">
                    <h3>📊 Upload Your CSV Files</h3>
                    <p>Click here or drag and drop your CSV files</p>
                    <p style="font-size: 12px; margin-top: 10px;">Supports multiple file uploads for comparison</p>
                </div>
            </div>
            <div id="fileList"></div>
        </div>

        <div class="tools-grid">
            <div class="tool-card">
                <h3>📋 Survey Response Analyzer</h3>
                <p>Analyze survey responses with automatic insights and sentiment analysis</p>
                <button class="btn" onclick="analyzeSurveys()" disabled id="surveyBtn">Analyze Surveys</button>
                <div id="surveyResults" class="results hidden"></div>
            </div>

            <div class="tool-card">
                <h3>📈 Trend Visualizer</h3>
                <p>Compare multiple datasets over time with interactive charts</p>
                <select id="trendColumn" disabled>
                    <option value="">Select time column</option>
                </select>
                <select id="valueColumn" disabled>
                    <option value="">Select value column</option>
                </select>
                <button class="btn" onclick="visualizeTrends()" disabled id="trendBtn">Visualize Trends</button>
                <div id="trendResults" class="results hidden"></div>
            </div>

            <div class="tool-card">
                <h3>🔗 Correlation Finder</h3>
                <p>Discover relationships and correlations in your data</p>
                <button class="btn" onclick="findCorrelations()" disabled id="correlationBtn">Find Correlations</button>
                <div id="correlationResults" class="results hidden"></div>
            </div>

            <div class="tool-card">
                <h3>🧪 A/B Test Calculator</h3>
                <p>Statistical significance checker for A/B tests</p>
                <div>
                    <input type="number" id="controlConversions" placeholder="Control conversions">
                    <input type="number" id="controlVisitors" placeholder="Control visitors">
                    <input type="number" id="treatmentConversions" placeholder="Treatment conversions">
                    <input type="number" id="treatmentVisitors" placeholder="Treatment visitors">
                </div>
                <button class="btn" onclick="calculateABTest()">Calculate Significance</button>
                <div id="abTestResults" class="results hidden"></div>
            </div>

            <div class="tool-card">
                <h3>🔄 Conversion Funnel Analyzer</h3>
                <p>Step-by-step user journey tracking and optimization</p>
                <select id="funnelSteps" disabled multiple>
                    <option value="">Select funnel steps</option>
                </select>
                <button class="btn" onclick="analyzeFunnel()" disabled id="funnelBtn">Analyze Funnel</button>
                <div id="funnelResults" class="results hidden"></div>
            </div>

            <div class="tool-card">
                <h3>🔥 Heatmap Generator</h3>
                <p>Visual data density representations</p>
                <select id="heatmapX" disabled>
                    <option value="">Select X axis</option>
                </select>
                <select id="heatmapY" disabled>
                    <option value="">Select Y axis</option>
                </select>
                <button class="btn" onclick="generateHeatmap()" disabled id="heatmapBtn">Generate Heatmap</button>
                <div id="heatmapResults" class="results hidden"></div>
            </div>
        </div>

        <div id="dataPreview" class="results hidden">
            <h3>📊 Data Preview</h3>
            <div id="dataStats"></div>
            <div id="dataTable"></div>
        </div>
    </div>

    <script>
        let datasets = [];
        let currentData = null;

        // File upload handling
        document.getElementById('csvFile').addEventListener('change', handleFiles);
        document.getElementById('fileUpload').addEventListener('click', () => {
            document.getElementById('csvFile').click();
        });

        // Drag and drop
        document.getElementById('fileUpload').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        });

        document.getElementById('fileUpload').addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        });

        document.getElementById('fileUpload').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles({ target: { files } });
        });

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            files.forEach(file => {
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'success';
                    fileDiv.innerHTML = `📁 ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    fileList.appendChild(fileDiv);

                    Papa.parse(file, {
                        complete: function(results) {
                            const dataset = {
                                name: file.name,
                                data: results.data,
                                headers: results.data[0] || []
                            };
                            datasets.push(dataset);
                            if (datasets.length === 1) {
                                currentData = dataset;
                                setupInterface();
                            }
                        },
                        header: false,
                        skipEmptyLines: true,
                        dynamicTyping: true
                    });
                }
            });
        }

        function setupInterface() {
            enableButtons();
            populateDropdowns();
            showDataPreview();
        }

        function enableButtons() {
            document.getElementById('surveyBtn').disabled = false;
            document.getElementById('trendBtn').disabled = false;
            document.getElementById('correlationBtn').disabled = false;
            document.getElementById('funnelBtn').disabled = false;
            document.getElementById('heatmapBtn').disabled = false;
            
            document.getElementById('trendColumn').disabled = false;
            document.getElementById('valueColumn').disabled = false;
            document.getElementById('funnelSteps').disabled = false;
            document.getElementById('heatmapX').disabled = false;
            document.getElementById('heatmapY').disabled = false;
        }

        function populateDropdowns() {
            const headers = currentData.headers;
            const selects = ['trendColumn', 'valueColumn', 'funnelSteps', 'heatmapX', 'heatmapY'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select column</option>';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
            });
        }

        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            const stats = document.getElementById('dataStats');
            const table = document.getElementById('dataTable');
            
            preview.classList.remove('hidden');
            
            // Basic stats
            const numRows = currentData.data.length - 1;
            const numCols = currentData.headers.length;
            
            stats.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${numRows}</div>
                        <div>Rows</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${numCols}</div>
                        <div>Columns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${datasets.length}</div>
                        <div>Datasets</div>
                    </div>
                </div>
            `;

            // Data table preview
            let tableHTML = '<table class="correlation-table"><thead><tr>';
            currentData.headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            const previewRows = currentData.data.slice(1, 6);
            previewRows.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${cell}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            table.innerHTML = tableHTML;
        }

        function analyzeSurveys() {
            const results = document.getElementById('surveyResults');
            results.classList.remove('hidden');
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            
            // Simple survey analysis
            const textColumns = headers.filter(h => 
                data.some(row => row[headers.indexOf(h)] && typeof row[headers.indexOf(h)] === 'string')
            );
            
            const numericColumns = headers.filter(h => 
                data.some(row => row[headers.indexOf(h)] && typeof row[headers.indexOf(h)] === 'number')
            );
            
            let analysis = '<h4>Survey Analysis Results</h4>';
            analysis += `<p><strong>Response Count:</strong> ${data.length}</p>`;
            analysis += `<p><strong>Text Fields:</strong> ${textColumns.length}</p>`;
            analysis += `<p><strong>Numeric Fields:</strong> ${numericColumns.length}</p>`;
            
            // Response distribution for numeric fields
            if (numericColumns.length > 0) {
                analysis += '<h5>Numeric Field Statistics:</h5>';
                numericColumns.forEach(col => {
                    const colIndex = headers.indexOf(col);
                    const values = data.map(row => row[colIndex]).filter(v => v !== null && v !== undefined);
                    if (values.length > 0) {
                        const avg = values.reduce((a, b) => a + b, 0) / values.length;
                        const max = Math.max(...values);
                        const min = Math.min(...values);
                        analysis += `<p><strong>${col}:</strong> Avg: ${avg.toFixed(2)}, Min: ${min}, Max: ${max}</p>`;
                    }
                });
            }
            
            results.innerHTML = analysis;
        }

        function visualizeTrends() {
            const trendColumn = document.getElementById('trendColumn').value;
            const valueColumn = document.getElementById('valueColumn').value;
            
            if (!trendColumn || !valueColumn) {
                alert('Please select both time and value columns');
                return;
            }
            
            const results = document.getElementById('trendResults');
            results.classList.remove('hidden');
            
            const canvas = document.createElement('canvas');
            canvas.id = 'trendChart';
            results.innerHTML = '<h4>Trend Analysis</h4><div class="chart-container"></div>';
            results.querySelector('.chart-container').appendChild(canvas);
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            const timeIndex = headers.indexOf(trendColumn);
            const valueIndex = headers.indexOf(valueColumn);
            
            const chartData = data.map(row => ({
                x: row[timeIndex],
                y: row[valueIndex]
            })).filter(point => point.x && point.y);
            
            new Chart(canvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: valueColumn,
                        data: chartData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: trendColumn
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: valueColumn
                            }
                        }
                    }
                }
            });
        }

        function findCorrelations() {
            const results = document.getElementById('correlationResults');
            results.classList.remove('hidden');
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            const numericColumns = headers.filter(h => {
                const colIndex = headers.indexOf(h);
                return data.some(row => typeof row[colIndex] === 'number');
            });
            
            if (numericColumns.length < 2) {
                results.innerHTML = '<p>Need at least 2 numeric columns for correlation analysis</p>';
                return;
            }
            
            // Calculate correlation matrix
            const correlationMatrix = [];
            
            for (let i = 0; i < numericColumns.length; i++) {
                correlationMatrix[i] = [];
                for (let j = 0; j < numericColumns.length; j++) {
                    const col1Index = headers.indexOf(numericColumns[i]);
                    const col2Index = headers.indexOf(numericColumns[j]);
                    
                    const values1 = data.map(row => row[col1Index]).filter(v => typeof v === 'number');
                    const values2 = data.map(row => row[col2Index]).filter(v => typeof v === 'number');
                    
                    const correlation = calculateCorrelation(values1, values2);
                    correlationMatrix[i][j] = correlation;
                }
            }
            
            // Display correlation matrix
            let tableHTML = '<h4>Correlation Matrix</h4><div class="correlation-matrix">';
            tableHTML += '<table class="correlation-table"><thead><tr><th></th>';
            numericColumns.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            for (let i = 0; i < numericColumns.length; i++) {
                tableHTML += `<tr><th>${numericColumns[i]}</th>`;
                for (let j = 0; j < numericColumns.length; j++) {
                    const corr = correlationMatrix[i][j];
                    const color = getCorrelationColor(corr);
                    tableHTML += `<td style="background-color: ${color}; color: white;">${corr.toFixed(3)}</td>`;
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table></div>';
            
            results.innerHTML = tableHTML;
        }

        function calculateCorrelation(x, y) {
            const n = Math.min(x.length, y.length);
            if (n === 0) return 0;
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function getCorrelationColor(correlation) {
            const abs = Math.abs(correlation);
            if (abs >= 0.8) return '#d32f2f';
            if (abs >= 0.6) return '#f57c00';
            if (abs >= 0.4) return '#fbc02d';
            if (abs >= 0.2) return '#689f38';
            return '#1976d2';
        }

        function calculateABTest() {
            const controlConv = parseInt(document.getElementById('controlConversions').value);
            const controlVis = parseInt(document.getElementById('controlVisitors').value);
            const treatmentConv = parseInt(document.getElementById('treatmentConversions').value);
            const treatmentVis = parseInt(document.getElementById('treatmentVisitors').value);
            
            if (!controlConv || !controlVis || !treatmentConv || !treatmentVis) {
                alert('Please fill in all fields');
                return;
            }
            
            const results = document.getElementById('abTestResults');
            results.classList.remove('hidden');
            
            const controlRate = controlConv / controlVis;
            const treatmentRate = treatmentConv / treatmentVis;
            const lift = ((treatmentRate - controlRate) / controlRate) * 100;
            
            // Simple z-test calculation
            const p1 = controlRate;
            const p2 = treatmentRate;
            const n1 = controlVis;
            const n2 = treatmentVis;
            
            const pooledP = (controlConv + treatmentConv) / (controlVis + treatmentVis);
            const se = Math.sqrt(pooledP * (1 - pooledP) * (1/n1 + 1/n2));
            const z = (p2 - p1) / se;
            const pValue = 2 * (1 - normalCDF(Math.abs(z)));
            
            const isSignificant = pValue < 0.05;
            
            results.innerHTML = `
                <h4>A/B Test Results</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${(controlRate * 100).toFixed(2)}%</div>
                        <div>Control Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(treatmentRate * 100).toFixed(2)}%</div>
                        <div>Treatment Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${lift.toFixed(2)}%</div>
                        <div>Lift</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${pValue.toFixed(4)}</div>
                        <div>P-value</div>
                    </div>
                </div>
                <div class="${isSignificant ? 'success' : 'error'}" style="margin-top: 20px;">
                    <strong>${isSignificant ? 'Statistically Significant' : 'Not Statistically Significant'}</strong>
                    <p>${isSignificant ? 'The difference is likely real and not due to chance.' : 'The difference could be due to chance.'}</p>
                </div>
            `;
        }

        function normalCDF(x) {
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }

        function erf(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        function analyzeFunnel() {
            const results = document.getElementById('funnelResults');
            results.classList.remove('hidden');
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            
            // Simple funnel analysis using first few columns as steps
            const steps = headers.slice(0, Math.min(5, headers.length));
            const stepData = steps.map(step => {
                const stepIndex = headers.indexOf(step);
                const count = data.filter(row => row[stepIndex]).length;
                return { name: step, count: count };
            });
            
            // Calculate conversion rates
            const totalUsers = stepData[0]?.count || 0;
            
            let funnelHTML = '<h4>Conversion Funnel Analysis</h4>';
            funnelHTML += '<div class="conversion-funnel">';
            
            stepData.forEach((step, index) => {
                const conversionRate = totalUsers > 0 ? (step.count / totalUsers * 100).toFixed(1) : 0;
                funnelHTML += `
                    <div class="funnel-step">
                        <div style="font-weight: bold;">${step.name}</div>
                        <div style="font-size: 1.5rem;">${step.count}</div>
                        <div>${conversionRate}%</div>
                    </div>
                `;
                if (index < stepData.length - 1) {
                    funnelHTML += '<div class="funnel-arrow">→</div>';
                }
            });
            
            funnelHTML += '</div>';
            
            // Drop-off analysis
            if (stepData.length > 1) {
                funnelHTML += '<h5>Drop-off Analysis</h5>';
                for (let i = 1; i < stepData.length; i++) {
                    const dropOff = stepData[i-1].count - stepData[i].count;
                    const dropOffRate = stepData[i-1].count > 0 ? (dropOff / stepData[i-1].count * 100).toFixed(1) : 0;
                    funnelHTML += `<p><strong>${stepData[i-1].name} → ${stepData[i].name}:</strong> ${dropOff} users dropped off (${dropOffRate}%)</p>`;
                }
            }
            
            results.innerHTML = funnelHTML;
        }

        function generateHeatmap() {
            const xColumn = document.getElementById('heatmapX').value;
            const yColumn = document.getElementById('heatmapY').value;
            
            if (!xColumn || !yColumn) {
                alert('Please select both X and Y columns');
                return;
            }
            
            const results = document.getElementById('heatmapResults');
            results.classList.remove('hidden');
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            const xIndex = headers.indexOf(xColumn);
            const yIndex = headers.indexOf(yColumn);
            
            // Create data bins
            const xValues = [...new Set(data.map(row => row[xIndex]).filter(v => v !== null && v !== undefined))];
            const yValues = [...new Set(data.map(row => row[yIndex]).filter(v => v !== null && v !== undefined))];
            
            // Sort values if numeric
            if (typeof xValues[0] === 'number') xValues.sort((a, b) => a - b);
            if (typeof yValues[0] === 'number') yValues.sort((a, b) => a - b);
            
            // Create heatmap data
            const heatmapData = {};
            yValues.forEach(y => {
                heatmapData[y] = {};
                xValues.forEach(x => {
                    heatmapData[y][x] = 0;
                });
            });
            
            // Count occurrences
            data.forEach(row => {
                const x = row[xIndex];
                const y = row[yIndex];
                if (x !== null && x !== undefined && y !== null && y !== undefined) {
                    if (heatmapData[y] && heatmapData[y][x] !== undefined) {
                        heatmapData[y][x]++;
                    }
                }
            });
            
            // Find max value for normalization
            const maxValue = Math.max(...Object.values(heatmapData).map(row => Math.max(...Object.values(row))));
            
            // Generate heatmap HTML
            let heatmapHTML = '<h4>Data Density Heatmap</h4>';
            heatmapHTML += `<div class="heatmap" style="grid-template-columns: repeat(${xValues.length + 1}, 1fr);">`;
            
            // Header row
            heatmapHTML += '<div class="heatmap-cell" style="background-color: #f0f0f0; color: #333;"></div>';
            xValues.forEach(x => {
                heatmapHTML += `<div class="heatmap-cell" style="background-color: #f0f0f0; color: #333;">${x}</div>`;
            });
            
            // Data rows
            yValues.forEach(y => {
                heatmapHTML += `<div class="heatmap-cell" style="background-color: #f0f0f0; color: #333;">${y}</div>`;
                xValues.forEach(x => {
                    const value = heatmapData[y][x];
                    const intensity = maxValue > 0 ? value / maxValue : 0;
                    const color = getHeatmapColor(intensity);
                    heatmapHTML += `<div class="heatmap-cell" style="background-color: ${color};">${value}</div>`;
                });
            });
            
            heatmapHTML += '</div>';
            
            // Add legend
            heatmapHTML += '<div style="margin-top: 20px;"><h5>Legend:</h5>';
            heatmapHTML += '<div style="display: flex; align-items: center; gap: 10px;">';
            heatmapHTML += '<span>Low</span>';
            for (let i = 0; i <= 10; i++) {
                const color = getHeatmapColor(i / 10);
                heatmapHTML += `<div style="width: 20px; height: 20px; background-color: ${color}; border: 1px solid #ccc;"></div>`;
            }
            heatmapHTML += '<span>High</span>';
            heatmapHTML += '</div></div>';
            
            results.innerHTML = heatmapHTML;
        }

        function getHeatmapColor(intensity) {
            // Create a color gradient from blue to red
            const r = Math.round(255 * intensity);
            const g = Math.round(100 * (1 - intensity));
            const b = Math.round(255 * (1 - intensity));
            return `rgb(${r}, ${g}, ${b})`;
        }

        // PHP/MySQL simulation functions
        function simulatePhpMysql() {
            // This would normally connect to a PHP backend with MySQL
            // For demo purposes, we'll simulate database operations
            console.log('Simulating PHP/MySQL operations...');
            
            // Sample MySQL-like operations
            const queries = [
                'SELECT * FROM analytics_data WHERE date >= "2024-01-01"',
                'INSERT INTO user_sessions (user_id, session_start, actions) VALUES (?, ?, ?)',
                'UPDATE conversion_rates SET rate = ? WHERE campaign_id = ?',
                'DELETE FROM temp_data WHERE created_at < DATE_SUB(NOW(), INTERVAL 7 DAY)'
            ];
            
            return {
                status: 'success',
                queries: queries,
                message: 'Database operations completed successfully'
            };
        }

        // Advanced analytics functions
        function calculateAdvancedMetrics() {
            if (!currentData || currentData.data.length < 2) return;
            
            const data = currentData.data.slice(1);
            const headers = currentData.headers;
            
            // Calculate additional metrics
            const metrics = {
                dataQuality: calculateDataQuality(data, headers),
                outliers: detectOutliers(data, headers),
                trends: detectTrends(data, headers),
                seasonality: detectSeasonality(data, headers)
            };
            
            return metrics;
        }

        function calculateDataQuality(data, headers) {
            const totalCells = data.length * headers.length;
            let missingValues = 0;
            let duplicateRows = 0;
            
            // Count missing values
            data.forEach(row => {
                row.forEach(cell => {
                    if (cell === null || cell === undefined || cell === '') {
                        missingValues++;
                    }
                });
            });
            
            // Detect duplicate rows
            const uniqueRows = new Set(data.map(row => JSON.stringify(row)));
            duplicateRows = data.length - uniqueRows.size;
            
            return {
                completeness: ((totalCells - missingValues) / totalCells * 100).toFixed(2),
                duplicates: duplicateRows,
                totalRows: data.length
            };
        }

        function detectOutliers(data, headers) {
            const outliers = [];
            
            headers.forEach((header, index) => {
                const values = data.map(row => row[index]).filter(v => typeof v === 'number');
                if (values.length > 0) {
                    const sorted = values.sort((a, b) => a - b);
                    const q1 = sorted[Math.floor(sorted.length * 0.25)];
                    const q3 = sorted[Math.floor(sorted.length * 0.75)];
                    const iqr = q3 - q1;
                    const lowerBound = q1 - 1.5 * iqr;
                    const upperBound = q3 + 1.5 * iqr;
                    
                    const columnOutliers = values.filter(v => v < lowerBound || v > upperBound);
                    if (columnOutliers.length > 0) {
                        outliers.push({
                            column: header,
                            count: columnOutliers.length,
                            percentage: (columnOutliers.length / values.length * 100).toFixed(2)
                        });
                    }
                }
            });
            
            return outliers;
        }

        function detectTrends(data, headers) {
            // Simple trend detection using linear regression
            const trends = [];
            
            headers.forEach((header, index) => {
                const values = data.map(row => row[index]).filter(v => typeof v === 'number');
                if (values.length > 2) {
                    const n = values.length;
                    const sumX = values.reduce((sum, val, i) => sum + i, 0);
                    const sumY = values.reduce((sum, val) => sum + val, 0);
                    const sumXY = values.reduce((sum, val, i) => sum + i * val, 0);
                    const sumX2 = values.reduce((sum, val, i) => sum + i * i, 0);
                    
                    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                    const direction = slope > 0 ? 'increasing' : slope < 0 ? 'decreasing' : 'stable';
                    
                    trends.push({
                        column: header,
                        direction: direction,
                        slope: slope.toFixed(4)
                    });
                }
            });
            
            return trends;
        }

        function detectSeasonality(data, headers) {
            // Simple seasonality detection (placeholder)
            // In a real implementation, this would use more sophisticated time series analysis
            return {
                detected: false,
                message: 'Advanced seasonality detection requires time series data with date columns'
            };
        }

        // Export functionality
        function exportResults() {
            const exportData = {
                datasets: datasets.map(d => ({
                    name: d.name,
                    rows: d.data.length - 1,
                    columns: d.headers.length
                })),
                timestamp: new Date().toISOString(),
                metrics: calculateAdvancedMetrics()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analysis_results.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Add export button to header
            const header = document.querySelector('.header');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn';
            exportBtn.textContent = '📥 Export Results';
            exportBtn.onclick = exportResults;
            exportBtn.style.marginTop = '10px';
            header.appendChild(exportBtn);
            
            // Add sample data button for testing
            const sampleBtn = document.createElement('button');
            sampleBtn.className = 'btn';
            sampleBtn.textContent = '📋 Load Sample Data';
            sampleBtn.onclick = loadSampleData;
            sampleBtn.style.marginTop = '10px';
            sampleBtn.style.marginLeft = '10px';
            header.appendChild(sampleBtn);
        });

        function loadSampleData() {
            // Create sample CSV data for testing
            const sampleData = [
                ['Date', 'Visitors', 'Conversions', 'Revenue', 'Source'],
                ['2024-01-01', 1000, 50, 2500, 'Google'],
                ['2024-01-02', 1200, 60, 3000, 'Facebook'],
                ['2024-01-03', 800, 40, 2000, 'Direct'],
                ['2024-01-04', 1500, 75, 3750, 'Google'],
                ['2024-01-05', 900, 45, 2250, 'Email'],
                ['2024-01-06', 1100, 55, 2750, 'Facebook'],
                ['2024-01-07', 1300, 65, 3250, 'Google']
            ];
            
            const dataset = {
                name: 'sample_data.csv',
                data: sampleData,
                headers: sampleData[0]
            };
            
            datasets = [dataset];
            currentData = dataset;
            
            // Update file list display
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div class="success">📁 sample_data.csv (Sample Data Loaded)</div>';
            
            setupInterface();
        }

        // Real-time data updates (simulation)
        function startRealTimeUpdates() {
            setInterval(() => {
                if (currentData && currentData.data.length > 1) {
                    // Simulate real-time data updates
                    const lastRow = currentData.data[currentData.data.length - 1];
                    const newRow = lastRow.map((val, index) => {
                        if (typeof val === 'number') {
                            return val + Math.round((Math.random() - 0.5) * val * 0.1);
                        }
                        return val;
                    });
                    
                    // Update timestamp if there's a date column
                    if (currentData.headers.includes('Date')) {
                        const dateIndex = currentData.headers.indexOf('Date');
                        const lastDate = new Date(lastRow[dateIndex]);
                        lastDate.setDate(lastDate.getDate() + 1);
                        newRow[dateIndex] = lastDate.toISOString().split('T')[0];
                    }
                    
                    currentData.data.push(newRow);
                    
                    // Update preview if visible
                    if (!document.getElementById('dataPreview').classList.contains('hidden')) {
                        showDataPreview();
                    }
                }
            }, 30000); // Update every 30 seconds
        }

        // Start real-time updates
        // startRealTimeUpdates();
        
        // Performance monitoring
        function monitorPerformance() {
            const startTime = performance.now();
            
            return {
                end: function() {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    console.log(`Operation completed in ${duration.toFixed(2)}ms`);
                    return duration;
                }
            };
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'o':
                        e.preventDefault();
                        document.getElementById('csvFile').click();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportResults();
                        break;
                    case 's':
                        e.preventDefault();
                        loadSampleData();
                        break;
                }
            }
        });

        // Add tooltips for better UX
        function addTooltips() {
            const tooltips = {
                'surveyBtn': 'Analyze survey responses with automatic insights',
                'trendBtn': 'Visualize data trends over time',
                'correlationBtn': 'Find relationships between variables',
                'funnelBtn': 'Analyze conversion funnel performance',
                'heatmapBtn': 'Generate visual data density maps'
            };
            
            Object.entries(tooltips).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                }
            });
        }

        // Initialize tooltips
        addTooltips();
    </script>
</body>
</html>